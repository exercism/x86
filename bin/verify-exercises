#!/bin/bash

set -e

run_tests() {
    local file="${1//-/_}"
    local implementation_file="${2}"

    pushd "$1"

    sed -i.bak 's#TEST_IGNORE();#// &#' "${file}"_test.c
    mv .meta/"${implementation_file}".asm "${file}".asm

    make clean
    make

    popd
}

main() {
    cd "$(dirname "$0")"/..

    rm -rf build
    cp -r exercises build

    pushd build/concept
    for exercise in *; do
        run_tests "${exercise}" "exemplar"
    done
    popd

    pushd build/practice
    for exercise in *; do
        run_tests "${exercise}" "example"
    done
    popd
}

main "$@"
